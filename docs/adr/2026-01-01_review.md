---
status: accepted
date: 2026-01-01
decision-makers:
  - kinushu
---

# dotfilesプロジェクトレビュー

## Context and Problem Statement

macOS開発環境の構成管理を行うdotfilesリポジトリの現状を評価し、改善点を特定する。

### リポジトリ構成

```
dotfiles/
├── bin/                    # ユーティリティスクリプト
├── config/                 # 管理対象の設定ファイル（ドットファイル）
├── cookbooks/              # Mitamaeレシピ
├── etc/                    # セットアップ・メンテナンススクリプト
├── roles/                  # Mitamaeロール定義
├── Brewfile                # Homebrewパッケージ定義
├── Makefile                # Legacy設定管理
├── node.json               # Mitamae変数定義
└── Gemfile                 # Ruby依存関係
```

## Decision Drivers

* deploy.shが`roles/darwin.rb`全体ではなく`cookbooks/dotfiles/default.rb`のみ実行している（影響度: 高）
* MakefileとMitamaeの二重管理で使い分けが不明確（影響度: 中）
* スクリプト間でエラーハンドリング（`set -eu`）が統一されていない（影響度: 中）
* node.jsonが最小限で拡張性が低い（影響度: 低）
* make cleanが未実装（影響度: 低）

## Considered Options

1. deploy.shを修正し`roles/darwin.rb`を実行するように統一
2. Makefileを整理しMitamaeベースに誘導
3. 全スクリプトでエラーハンドリングを統一
4. node.jsonにアーキテクチャ・ユーザー情報を追加
5. make cleanを実装

## Decision Outcome

全オプションを優先度順に実施する:

1. **deploy.shの修正**（優先度: 高）
   ```bash
   # 現状
   bin/mitamae local ./cookbooks/dotfiles/default.rb

   # 推奨
   bin/mitamae local ./roles/darwin.rb --node-json node.json
   ```

2. **Makefileの整理**（優先度: 中）
   - READMEでMitamaeベースを推奨
   - レガシー経路を明確化

3. **エラーハンドリングの統一**（優先度: 中）
   - 全スクリプトで`set -eu`を標準化

4. **node.jsonの拡張**（優先度: 低）
   ```json
   {
     "platform": "darwin",
     "arch": "arm64",
     "user": "kinushu",
     "home": "/Users/kinushu"
   }
   ```

5. **make cleanの実装**（優先度: 低）

## Consequences

### Good

* 設定管理の経路が明確になる
* エラー発生時の動作が予測可能になる
* 将来のマルチプラットフォーム対応が容易になる

### Bad

* 既存のワークフローに影響が出る可能性がある

## More Information

### 実装状況（2026-01-16更新）

| # | 改善項目 | 優先度 | 状態 |
|---|---------|-------|------|
| 1 | deploy.shの修正 | 高 | 未対応（現状維持） |
| 2 | Makefileの整理 | 中 | ✅ 完了（deploy-dry-run, check-links, clean追加） |
| 3 | エラーハンドリングの統一 | 中 | ✅ 完了（全スクリプトでset -eu） |
| 4 | node.jsonの拡張 | 低 | ✅ 一部完了（archのみ追加） |
| 5 | make cleanの実装 | 低 | ✅ 完了 |

### 現状の良い点

1. **Mitamaeによる宣言的な構成管理**
   - 冪等性が担保されており、何度実行しても安全
   - cookbooks構成で役割が分離されている
   - `roles/darwin.rb` → `roles/base.rb` → 各cookbookの階層構造

2. **充実したツール管理**
   - Brewfileで150以上のツールを一括管理（90+ formulae / 50+ casks）
   - miseで言語バージョン管理（Go, Python, Node.js, Ruby）
   - VS Code拡張も15個管理

3. **Claude Code統合**
   - `.claude/settings.json`でパーミッション制御
   - `gemini-search`カスタムコマンド
   - 日本語コミットメッセージスキル

4. **セキュリティ対策**
   - git-secretsでAWS認証情報のコミット防止
   - `.env`ファイルの読み書き禁止設定

5. **シェル設定の整理**
   - 設定の読み込み順序が明確（`.bash_profile` → `.bashrc` → `.zshrc` → `~/.bashrc.local`）

### 管理対象ファイル一覧

cookbooks/dotfiles/default.rbで管理されているファイル:

- `.bash_profile`, `.bashrc`, `.zshrc`, `.vimrc`, `.gemrc`
- `.gitignore_global`
- `.claude/CLAUDE.md`, `.claude/settings.json`
- `.claude/commands/gemini-search.md`
- `.claude/skills/commit-message/SKILL.md`
- `.config/ghostty/config`, `.config/mise/config.toml`, `.config/starship.toml`
- `.codex/AGENTS.md`
